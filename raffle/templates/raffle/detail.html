{% extends "base.html" %}
{% block title %}{{ raffle.title|default:"Rifa Milo" }}{% endblock %}

{% block content %}
{% if not raffle %}
  <div class="p-6 bg-white rounded-xl shadow">No hay rifa activa por ahora.</div>
{% else %}

{% load static %}
<!-- Config para JS externos -->
<div id="mp-config"
     data-public-key="{{ MP_PUBLIC_KEY }}"
     data-price="{{ raffle.price_clp }}"
     data-raffle-id="{{ raffle.id }}">
</div>

<section class="mb-8">
  <div class="w-full max-h-[65vh] overflow-hidden rounded-xl shadow">
    <img 
      src="{% static 'img/Milo_fondo.png' %}" 
      alt="Collage de Milo"
      class="w-full h-full object-cover md:object-contain bg-white"
    >
  </div>
</section>

<div class="mb-6">
  <h1 class="text-2xl font-bold">{{ raffle.title }}</h1>
  <p class="text-gray-600">{{ raffle.description }}</p>
  <p class="mt-2">Precio por n√∫mero: <span class="font-semibold">${{ raffle.price_clp }}</span> CLP</p>
  
  {% if request.GET.ok %}
    <p class="text-green-700 mt-2">
      ¬°Pago confirmado!
    </p>
  {% endif %}

  {% if request.GET.fail %}
    <p class="text-red-700 mt-2">
      El pago fue rechazado o fall√≥. Puedes intentar nuevamente.
    </p>
  {% endif %}

  {% if request.GET.pending %}
    <p class="text-yellow-700 mt-2">
      Tu pago est√° pendiente de aprobaci√≥n. Te notificaremos por correo.
    </p>
  {% endif %}

</div>

<section class="mb-8 bg-white rounded-xl shadow p-4">
  <div class="flex flex-col md:flex-row md:items-center gap-4">
    <div class="flex-1">
      <h2 class="text-lg font-bold mb-1">üéÅ Primer premio</h2>
      <p class="text-gray-700">
        Pase diario a <span class="font-semibold">Lollapalooza Chile 2026</span>  
        para el d√≠a <span class="font-semibold">viernes 13 de marzo</span>.
      </p>
      <p class="text-sm text-gray-500 mt-1">
        Adem√°s de ayudar a que Milo pueda operarse y dejar de cojear, estar√°s participando por muchos otros premios.
      </p>

      <a href="/premios/"
         class="inline-block mt-3 text-sm text-indigo-600 hover:text-indigo-800 underline font-medium">
        Ver todos los premios ‚Üí
      </a>
    </div>

    <!-- LOGO LOLLAPALOOZA -->
    <div class="w-full md:w-40 lg:w-48 flex-shrink-0">
      <img
        src="{% static 'img/lollapalooza_logo.jpg' %}"
        alt="Logo Lollapalooza Chile 2026"
        class="w-full h-auto object-contain"
      >
    </div>
  </div>
</section>

<!-- BLOQUE DE DONACIONES -->
<div class="mt-6 mb-6 bg-green-50 border border-green-300 shadow-sm rounded-xl p-4">
    <h2 class="text-xl font-semibold text-green-800">
        ¬øQuieres ayudar directamente a Milo? üíö
    </h2>
    <p class="text-sm text-green-700 mt-1">
        Milo necesita una cirug√≠a compleja para dejar de cojear.  
        Si no quieres participar en la rifa pero s√≠ deseas ayudarlo, puedes hacer una donaci√≥n directa.
    </p>

    <a href="/donar/"
       class="inline-block mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow">
        HAZ UNA DONACI√ìN
    </a>
</div>

<div class="grid md:grid-cols-3 gap-6">
  <!-- Grilla 10x10 con paginaci√≥n -->
  <div class="md:col-span-2">
    <h2 class="font-semibold mb-2">Elige tus n√∫meros</h2>

    <!-- Contenedor de la grilla -->
    <div id="numbers-grid"
        hx-trigger="refreshGrid from:body"
        hx-get="{% url 'grid_page' %}?page={{ current_page }}"
        hx-target="#numbers-grid"
        hx-swap="innerHTML">
      {% include "raffle/_grid.html" with numbers=first_page_numbers taken=taken current_page=current_page page_count=page_count %}
    </div>

    <div id="availability" class="text-sm text-gray-600 mt-3">
      Toca para seleccionar/deseleccionar n√∫meros disponibles.
    </div>
  </div>

  <!-- Formulario comprador + resumen (igual que antes) -->
  <div class="bg-white rounded-xl shadow p-4">
    <h2 class="font-semibold mb-2">Tus datos</h2>

    <label class="block text-sm font-medium mb-1">Nombre</label>
    <input id="buyer_name" type="text" class="w-full border rounded px-3 py-2 mb-2" required>

    <label class="block text-sm font-medium mb-1">Email</label>
    <input id="buyer_email" type="email" class="w-full border rounded px-3 py-2 mb-2" required>

    <label class="block text-sm font-medium mb-1">Tel√©fono (opcional)</label>
    <input id="buyer_phone" type="text" class="w-full border rounded px-3 py-2 mb-4">

    <div class="rounded-lg border p-3 text-sm bg-gray-50 mb-4">
      <div><strong>Seleccionados:</strong> <span id="selected-count">0</span></div>
      <div class="truncate"><strong>N√∫meros:</strong> <span id="selected-list">‚Äî</span></div>
      <div class="mt-1"><strong>Total:</strong> $<span id="selected-total">0</span> CLP</div>
    </div>

    <!-- Bot√≥n / Brick de Mercado Pago -->
    <div id="walletBrick_container" class="mt-4"></div>

    <!-- Opci√≥n de transferencia -->
    <div id="transfer-section" class="mt-6 text-sm border-t pt-4">
      <p class="font-semibold mb-1">¬øPrefieres pagar por transferencia?</p>
      <p class="text-gray-700 mb-2">
        Haz click aqu√≠ <span class="font-semibold">SOLO</span> si quieres pagar por este medio.
        <br>
        <span class="text-xs">
          (Tus n√∫meros quedar√°n reservados por 12 horas hasta que comprobemos el pago)
        </span>
      </p>
      <button
        id="transfer-btn"
        type="button"
        class="w-full px-3 py-2 rounded-md border bg-white hover:bg-gray-100 text-sm">
        Reservar n√∫meros para transferencia
      </button>
      <p id="transfer-message" class="mt-2 text-xs text-gray-700"></p>

      <!-- DATOS BANCARIOS: SIEMPRE VISIBLES -->
      <div id="bank-details" class="mt-4">
        <div class="rounded-lg border bg-white p-4 shadow-sm">
          <p class="text-sm font-semibold mb-2">Datos para transferencia</p>
          <dl class="text-sm space-y-1">
            <div class="flex justify-between">
              <dt class="text-gray-500">Banco</dt>
              <dd class="font-medium">Mercado Pago</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">Tipo de cuenta</dt>
              <dd class="font-medium">Cuenta Vista</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">N¬∞ de cuenta</dt>
              <dd class="font-medium">1052076645</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">RUT</dt>
              <dd class="font-medium">20.096.901-4</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">Nombre</dt>
              <dd class="font-medium">Marcelo Pizarro</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">Correo</dt>
              <dd class="font-medium">marcelo.pizarrotapia@gmail.com</dd>
            </div>
          </dl>

          <p class="mt-3 text-xs text-gray-600">
            Por favor env√≠a el comprobante de transferencia al correo indicado, indicando tu nombre y los
            n√∫meros que reservaste. <br>
            <span class="font-semibold">Tienes 12 horas</span> para realizar la transferencia antes de que
            los n√∫meros vuelvan a quedar disponibles.
          </p>
        </div>
      </div>
    </div>


  </div>
</div>

{% endif %}
{% endblock %}