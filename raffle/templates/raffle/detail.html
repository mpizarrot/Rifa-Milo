{% extends "base.html" %}
{% block title %}{{ raffle.title|default:"Rifa Milo" }}{% endblock %}

{% block content %}
{% if not raffle %}
  <div class="p-6 bg-white rounded-xl shadow">No hay rifa activa por ahora.</div>
{% else %}

{% load static %}
<style>
  .number-btn:hover:not(.is-selected) {
    background-color: rgb(239, 246, 255);
  }
</style>

<!-- Config para JS externos -->
<div id="mp-config"
     data-public-key="{{ MP_PUBLIC_KEY }}"
     data-price="{{ raffle.price_clp }}"
     data-raffle-id="{{ raffle.id }}">
</div>

<section class="mb-8">
  <div class="w-full max-h-[65vh] overflow-hidden rounded-xl shadow">
    <img 
      src="{% static 'img/Milo_fondo.png' %}" 
      alt="Collage de Milo"
      class="w-full h-full object-cover md:object-contain bg-white"
    >
  </div>
</section>

<div class="mb-6">
  <h1 class="text-2xl font-bold">{{ raffle.title }}</h1>
  <p class="text-gray-600">{{ raffle.description }}</p>
  <p class="mt-2">Precio por nÃºmero: <span class="font-semibold">${{ raffle.price_clp }}</span> CLP</p>
</div>

{% if request.GET.fail %}
<div class="mt-4 p-3 rounded-md bg-red-50 border border-red-300">
    <p class="text-red-800 font-semibold">
    El pago no pudo completarse ğŸ˜¢  
    Por favor intenta nuevamente. Milo te lo agradecerÃ­a muchÃ­simo.
    </p>
</div>
{% endif %}

{% if request.GET.pending %}
<div class="mt-4 p-3 rounded-md bg-yellow-50 border border-yellow-300">
    <p class="text-yellow-800 font-semibold">
    Tu pago estÃ¡ siendo procesado ğŸ’›  
    Te avisaremos por correo apenas se confirme.  
    Â¡Gracias por ayudar a Milo!
    </p>
</div>
{% endif %}

<section class="mb-8 bg-white rounded-xl shadow p-4">
  <div class="flex flex-col md:flex-row md:items-center gap-4">
    <div class="flex-1">
      <h2 class="text-lg font-bold mb-1">ğŸ Primer premio</h2>
      <p class="text-gray-700">
        Pase diario a <span class="font-semibold">Lollapalooza Chile 2026</span>  
        para el dÃ­a <span class="font-semibold">viernes 13 de marzo</span>.
      </p>
      <p class="text-sm text-gray-500 mt-1">
        AdemÃ¡s de ayudar a que Milo pueda operarse y dejar de cojear, estarÃ¡s participando por muchos otros premios.
      </p>

      <a href="/premios/"
         class="inline-block mt-3 text-sm text-indigo-600 hover:text-indigo-800 underline font-medium">
        Ver todos los premios â†’
      </a>
    </div>

    <!-- LOGO LOLLAPALOOZA -->
    <div class="w-full md:w-40 lg:w-48 flex-shrink-0">
      <img
        src="{% static 'img/lollapalooza_logo.jpg' %}"
        alt="Logo Lollapalooza Chile 2026"
        class="w-full h-auto object-contain"
      >
    </div>
  </div>
</section>

<!-- BLOQUE DE DONACIONES -->
<div class="mt-6 mb-6 bg-green-50 border border-green-300 shadow-sm rounded-xl p-4">
    <h2 class="text-xl font-semibold text-green-800">
        Â¿Quieres ayudar directamente a Milo? ğŸ’š
    </h2>
    <p class="text-sm text-green-700 mt-1">
        Milo necesita una cirugÃ­a compleja para dejar de cojear.  
        Si no quieres participar en la rifa pero sÃ­ deseas ayudarlo, puedes hacer una donaciÃ³n directa.
    </p>

    <a href="/donar/"
       class="inline-block mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow">
        HAZ UNA DONACIÃ“N
    </a>
</div>

<div class="grid md:grid-cols-3 gap-6">
  <!-- Grilla 10x10 con paginaciÃ³n -->
  <div class="md:col-span-2">
    <h2 class="font-semibold mb-2">Elige tus nÃºmeros</h2>

    <!-- Contenedor de la grilla -->
    <div id="numbers-grid"
        hx-trigger="refreshGrid from:body"
        hx-get="{% url 'grid_page' %}?page={{ current_page }}"
        hx-target="#numbers-grid"
        hx-swap="innerHTML">
      {% include "raffle/_grid.html" with numbers=first_page_numbers taken=taken current_page=current_page page_count=page_count %}
    </div>

    <div id="availability" class="text-sm text-gray-600 mt-3">
      Toca para seleccionar/deseleccionar nÃºmeros disponibles.
    </div>
  </div>

  <!-- Formulario comprador + resumen (igual que antes) -->
  <div class="bg-white rounded-xl shadow p-4">
    <h2 class="font-semibold mb-2">Tus datos</h2>

    <label class="block text-sm font-medium mb-1">Nombre</label>
    <input id="buyer_name" type="text" class="w-full border rounded px-3 py-2 mb-2" required>

    <label class="block text-sm font-medium mb-1">Email</label>
    <input id="buyer_email" type="email" class="w-full border rounded px-3 py-2 mb-2" required>

    <label class="block text-sm font-medium mb-1">TelÃ©fono (opcional)</label>
    <input id="buyer_phone" type="text" class="w-full border rounded px-3 py-2 mb-4">

    <div class="rounded-lg border p-3 text-sm bg-gray-50 mb-4">
      <div><strong>Seleccionados:</strong> <span id="selected-count">0</span></div>
      <div class="truncate"><strong>NÃºmeros:</strong> <span id="selected-list">â€”</span></div>
      <div class="mt-1"><strong>Total:</strong> $<span id="selected-total">0</span> CLP</div>
      <p class="text-xs text-gray-500 mt-1">
        Puedes pagar con dÃ©bito o crÃ©dito por Mercado Pago o con transferencia bancaria.
      </p>
    </div>

    <!-- Acciones de pago: Mercado Pago + Transferencia -->
    <div class="mt-4 space-y-3" id="payment-actions">
      <!-- BotÃ³n / Brick de Mercado Pago -->
      <div id="wallet-wrapper" class="w-full">
        <div
          id="walletBrick_container"
          class="w-full min-h-[64px] flex items-center justify-center"
        >
          <p id="wallet-placeholder" class="text-xs text-gray-500 text-center px-2">
            El botÃ³n de pago aparecerÃ¡ aquÃ­ cuando selecciones tus nÃºmeros
            e ingreses tu nombre y correo.
          </p>
        </div>
      </div>

      <!-- OpciÃ³n de transferencia -->
      <div id="transfer-section" class="text-sm">
        <button
          id="transfer-btn"
          type="button"
          class="w-full px-3 py-2 rounded-md border bg-white hover:bg-gray-100 text-sm"
        >
          Reservar nÃºmeros para transferencia
        </button>

        <p class="mt-1 text-xs text-gray-600 text-center">
          Haz click aquÃ­ <span class="font-semibold">SOLO</span> si quieres pagar por transferencia.
        </p>

        <p class="mt-2 text-xs text-gray-700" id="transfer-message"></p>
      </div>
    </div>
  </div>
</div>

<div
  id="global-loader"
  class="fixed inset-0 flex items-center justify-center z-50 hidden"
  style="background: rgba(255, 255, 255, 0.75);"
>
  <div class="h-12 w-12 rounded-full border-4 border-gray-300 border-t-gray-700 animate-spin"></div>
</div>

{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/checkout_pro.js' %}" defer></script>
<script src="{% static 'js/detail_page.js' %}" defer></script>
{% endblock %}